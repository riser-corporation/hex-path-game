<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hex-Path â€” Territory War by Riser Corp</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;600;800&display=swap');

        :root {
            --bg: #020617;
            --glass: rgba(15, 23, 42, 0.95);
            --primary: #38bdf8;
            --secondary: #f472b6;
            --accent: #6366f1;
            --text: #f8fafc;
            --danger: #ef4444;
            --success: #22c55e;
            --gold: #fbbf24;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            background-image: radial-gradient(circle at 20% 30%, rgba(56, 189, 248, 0.1) 0%, transparent 40%);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .glass { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; box-shadow: 0 10px 50px rgba(0,0,0,0.5); }
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; transition: 0.5s ease-in-out; }
        .hidden { opacity: 0; visibility: hidden; pointer-events: none; transform: scale(0.95); }

        /* BUTTONS & INPUTS */
        .btn { padding: 12px 24px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: #fff; }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 5px 25px rgba(56, 189, 248, 0.4); }
        input { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; color: white; width: 100%; outline: none; transition: 0.3s; }
        
        /* LOBBY */
        .lobby-container { display: grid; grid-template-columns: 350px 1fr; width: 95vw; height: 90vh; gap: 20px; }
        .sidebar { padding: 20px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .main-lobby { padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        .profile-section { display: flex; align-items: center; gap: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); position: relative; }
        .avatar-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; }
        .edit-btn { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 1.1rem; padding: 5px; }

        .coin-box { display: flex; align-items: center; gap: 8px; color: var(--gold); font-weight: 900; font-size: 1.1rem; margin-top: 10px; font-family: 'Orbitron'; }

        /* LISTS */
        .list-area { flex: 1; overflow-y: auto; margin-top: 20px; }
        .card { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 16px; background: rgba(255,255,255,0.03); margin-bottom: 10px; border: 1px solid transparent; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }

        /* GAME SCREEN & CHAT */
        .game-hud { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 50px; z-index: 50; }
        #chat-container { position: fixed; bottom: 80px; left: 20px; width: 280px; height: 200px; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.8rem; display: flex; flex-direction: column; gap: 5px; }
        .msg { padding: 5px 10px; border-radius: 8px; max-width: 80%; }
        .msg.me { align-self: flex-end; background: var(--primary); color: #000; }
        .msg.them { align-self: flex-start; background: rgba(255,255,255,0.1); }

        /* FLOATING FRIEND ICON */
        #friend-toggle-btn { position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; font-size: 1.5rem; }

        canvas { cursor: pointer; max-width: 95vw; max-height: 70vh; margin-top: 60px; }

        footer { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: #64748b; letter-spacing: 2px; }

        @media (max-width: 1000px) { .lobby-container { grid-template-columns: 1fr; } .sidebar { display: none; } .sidebar.active { display: flex; position: fixed; inset: 10px; z-index: 2000; width: auto; height: auto; } }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="screen">
        <div class="auth-card glass" style="padding: 50px; width: 400px; text-align: center;">
            <h1 style="font-family: 'Orbitron'; font-size: 2.5rem; color: var(--primary);">HEX-PATH</h1>
            <p style="margin-bottom: 30px; font-size: 0.8rem; letter-spacing: 2px;">BY RISER CORPORATION</p>
            <input type="text" id="auth-id" placeholder="Gamer ID" style="margin-bottom: 15px;">
            <input type="password" id="auth-pass" placeholder="Password" style="margin-bottom: 25px;">
            <button id="btn-login" class="btn btn-primary" style="width: 100%;">Enter Arena</button>
        </div>
    </div>

    <!-- PROFILE EDIT MODAL -->
    <div id="profile-modal" class="screen hidden" style="background: rgba(0,0,0,0.8); z-index: 3000;">
        <div class="glass" style="padding: 30px; width: 320px;">
            <h3 style="margin-bottom: 20px;">Edit Profile</h3>
            <label style="font-size: 0.7rem;">Display Name</label>
            <input type="text" id="edit-name" style="margin-bottom: 15px;">
            <label style="font-size: 0.7rem;">Avatar URL</label>
            <input type="text" id="edit-avatar" placeholder="https://image.url" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
                <button id="btn-save-profile" class="btn btn-primary" style="flex:1;">Save</button>
                <button id="btn-close-profile" class="btn" style="flex:1;">Back</button>
            </div>
        </div>
    </div>

    <!-- LOBBY SCREEN -->
    <div id="lobby-screen" class="screen hidden">
        <div class="lobby-container">
            <aside id="sidebar-panel" class="sidebar glass">
                <div class="profile-section">
                    <img id="my-img" class="avatar-img" src="https://api.dicebear.com/7.x/bottts/svg?seed=Riser">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span id="my-id-display" style="font-weight: 800;">ID</span>
                            <button class="edit-btn" id="btn-open-profile">âœŽ</button>
                        </div>
                        <div class="coin-box">ðŸª™ <span id="my-coins">0</span></div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <input type="text" id="friend-search" placeholder="Search Gamer ID..." style="font-size: 0.8rem; margin-bottom: 10px;">
                    <button id="btn-search" class="btn btn-primary" style="width: 100%; font-size: 0.7rem;">SEND FRIEND REQUEST</button>
                </div>

                <div class="list-area">
                    <h4 style="font-size: 0.7rem; color: #64748b; margin-bottom: 10px;">SOCIALS</h4>
                    <div id="social-list"></div>
                </div>
                <button id="btn-logout" class="btn" style="font-size: 0.7rem; color: var(--danger);">LOGOUT</button>
            </aside>

            <main class="main-lobby glass">
                <h1 style="font-family: 'Orbitron'; font-size: 3rem; margin-bottom: 10px;">WAR ROOM</h1>
                <p style="color: #64748b; margin-bottom: 30px;">Select map complexity to begin</p>
                
                <div style="display: flex; gap: 15px; margin-bottom: 40px;">
                    <button class="btn sz-btn" data-sz="7">7x7</button>
                    <button class="btn sz-btn active" data-sz="9" style="border: 1px solid var(--primary);">9x9</button>
                    <button class="btn sz-btn" data-sz="11">11x11</button>
                </div>

                <button id="btn-matchmaking" class="btn btn-primary" style="width: 350px; height: 70px; font-size: 1.3rem;">Find Random Opponent</button>
                <div id="mm-status" class="hidden" style="margin-top: 20px;">Scanning Global Servers...</div>
                
                <footer>CREATED BY RISER CORPORATION</footer>
            </main>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="screen hidden" style="background: #010409;">
        <div class="game-header">
            <div id="p1-hud" class="hud-player" style="color: var(--p1);">
                <div id="p1-name" style="font-weight: 900;">P1</div>
            </div>
            <div class="glass" style="padding: 10px 40px; text-align: center;">
                <div id="timer-val" style="font-family: 'Orbitron'; font-size: 2rem;">15</div>
            </div>
            <div id="p2-hud" class="hud-player" style="color: var(--p2);">
                <div id="p2-name" style="font-weight: 900;">P2</div>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <!-- CHAT SECTION -->
        <div id="chat-container" class="glass">
            <div id="chat-messages"></div>
            <div style="display: flex; padding: 5px;">
                <input type="text" id="chat-input" placeholder="Type a message..." style="font-size: 0.7rem; border-radius: 8px 0 0 8px;">
                <button id="btn-chat-send" class="btn btn-primary" style="padding: 0 15px; border-radius: 0 8px 8px 0;">âž¤</button>
            </div>
        </div>

        <button id="btn-forfeit" class="btn glass" style="position: absolute; bottom: 20px; right: 20px; color: var(--danger);">FORFEIT</button>
    </div>

    <div id="result-screen" class="screen hidden" style="background: rgba(0,0,0,0.95); z-index: 1000;">
        <h1 id="result-text" style="font-family: 'Orbitron'; font-size: 4rem; margin-bottom: 10px;">VICTORY</h1>
        <p id="coin-reward" style="color: var(--gold); font-weight: 900; margin-bottom: 30px;">+50 COINS EARNED</p>
        <button id="btn-back" class="btn btn-primary">Back to Lobby</button>
    </div>

    <!-- CHALLENGE POPUP -->
    <div id="invite-popup" class="glass hidden" style="position: fixed; bottom: 30px; left: 30px; padding: 25px; z-index: 2000; width: 320px; border: 2px solid var(--primary);">
        <p id="invite-msg" style="margin-bottom: 20px; font-weight: 600;"></p>
        <div style="display: flex; gap: 10px;">
            <button id="btn-accept-inv" class="btn btn-primary" style="flex:1;">ACCEPT</button>
            <button id="btn-decline-inv" class="btn btn-outline" style="flex:1;">IGNORE</button>
        </div>
    </div>

    <div id="friend-toggle-btn" class="hidden">ðŸ‘¥</div>
    <button id="mute-btn" style="position: fixed; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; z-index: 1000; cursor: pointer;">ðŸ”Š</button>
    <div id="toast-container"></div>

    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
        }
    }
    </script>

    <script type="module">
        import { initializeApp } from 'firebase/app';
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect, serverTimestamp, get, push } from 'firebase/database';

        // --- AUDIO MANAGER ---
        class HexAudio {
            constructor() {
                this.bgm = new Audio('Hexmusic.mp3');
                this.bgm.loop = true;
                this.bgm.volume = 0.4;
                this.muted = false;
            }
            play() { this.bgm.play().catch(() => {}); }
            toggle() { this.muted = !this.muted; this.bgm.muted = this.muted; return this.muted; }
        }
        const audio = new HexAudio();

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB-1X3w7cO3gY0XoxR9FN75AwPecCsyWvY",
            authDomain: "multiplayer-1c796.firebaseapp.com",
            projectId: "multiplayer-1c796",
            storageBucket: "multiplayer-1c796.firebasestorage.app",
            messagingSenderId: "563940022848",
            appId: "1:563940022848:web:484112afa3b3d77c051da5"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- STATE ---
        let myId = localStorage.getItem('hex_user');
        let myPass = localStorage.getItem('hex_pass');
        let matchData = null;
        let activeMatchId = null;
        let myIdx = 0;
        let boardSize = 9;
        let hexRad = 25;
        let timerInt = null;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const show = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${id}-screen`).classList.remove('hidden');
        };

        // --- AUTH & PROFILE ---
        document.getElementById('btn-login').onclick = async () => {
            const id = document.getElementById('auth-id').value.trim().toLowerCase();
            const pass = document.getElementById('auth-pass').value.trim();
            if (id.length < 3) return alert("ID too short");
            
            const snap = await get(ref(db, `users/${id}`));
            if (snap.exists()) {
                if (snap.val().pass === pass) loginSuccess(id, pass);
                else alert("Wrong password");
            } else {
                await set(ref(db, `users/${id}`), { id, pass, coins: 0, name: id, photo: `https://api.dicebear.com/7.x/bottts/svg?seed=${id}` });
                loginSuccess(id, pass);
            }
        };

        function loginSuccess(id, pass) {
            myId = id; myPass = pass;
            localStorage.setItem('hex_user', id);
            localStorage.setItem('hex_pass', pass);
            audio.play();
            show('lobby');
            document.getElementById('friend-toggle-btn').classList.remove('hidden');
            const uRef = ref(db, `users/${myId}`);
            update(uRef, { online: true });
            onDisconnect(uRef).update({ online: false });
            initLobby();
        }

        if (myId && myPass) loginSuccess(myId, myPass);

        // --- PROFILE EDIT ---
        document.getElementById('btn-open-profile').onclick = async () => {
            const snap = await get(ref(db, `users/${myId}`));
            document.getElementById('edit-name').value = snap.val().name;
            document.getElementById('edit-avatar').value = snap.val().photo;
            document.getElementById('profile-modal').classList.remove('hidden');
        };

        document.getElementById('btn-save-profile').onclick = async () => {
            const name = document.getElementById('edit-name').value.trim();
            const photo = document.getElementById('edit-avatar').value.trim();
            await update(ref(db, `users/${myId}`), { name, photo });
            document.getElementById('profile-modal').classList.add('hidden');
        };
        document.getElementById('btn-close-profile').onclick = () => document.getElementById('profile-modal').classList.add('hidden');

        // --- LOBBY LOGIC ---
        function initLobby() {
            onValue(ref(db, `users/${myId}`), (s) => {
                const d = s.val();
                document.getElementById('my-id-display').innerText = `@${d.id}`;
                document.getElementById('my-img').src = d.photo;
                document.getElementById('my-coins').innerText = d.coins || 0;
            });

            // Social & Invites
            onValue(ref(db, `users/${myId}/requests`), (s) => {
                const list = document.getElementById('social-list');
                list.innerHTML = '';
                const data = s.val() || {};
                Object.keys(data).forEach(rid => {
                    const d = document.createElement('div');
                    d.className = 'card';
                    d.innerHTML = `<span style="flex:1;font-size:0.7rem">${rid} sent request</span>
                        <button class="btn btn-primary" style="padding:5px" onclick="acceptFriend('${rid}')">ACCEPT</button>`;
                    list.appendChild(d);
                });
            });

            onValue(ref(db, `users/${myId}/friends`), (s) => {
                const friends = s.val() || {};
                Object.keys(friends).forEach(fid => {
                    get(ref(db, `users/${fid}`)).then(fs => {
                        const f = fs.val();
                        const d = document.createElement('div');
                        d.className = 'card';
                        d.innerHTML = `<div class="status-dot" style="background:${f.online? 'var(--success)':'#444'}"></div>
                            <span style="flex:1;font-size:0.7rem">${f.name}</span>
                            <button class="btn btn-primary" style="padding:5px" onclick="challengeFriend('${fid}')">PLAY</button>`;
                        document.getElementById('social-list').appendChild(d);
                    });
                });
            });

            onValue(ref(db, `users/${myId}/invites`), (s) => {
                const inv = s.val();
                if (inv) {
                    const sid = Object.keys(inv)[0];
                    document.getElementById('invite-msg').innerText = `${sid} wants to play ${inv[sid].sz}x${inv[sid].sz}!`;
                    document.getElementById('invite-popup').classList.remove('hidden');
                    document.getElementById('btn-accept-inv').onclick = () => startFriendMatch(sid, inv[sid]);
                } else document.getElementById('invite-popup').classList.add('hidden');
            });

            onValue(ref(db, `users/${myId}/match`), (s) => { if(s.val()) startMatch(s.val()); });
        }

        window.acceptFriend = async (rid) => {
            await set(ref(db, `users/${myId}/friends/${rid}`), true);
            await set(ref(db, `users/${rid}/friends/${myId}`), true);
            remove(ref(db, `users/${myId}/requests/${rid}`));
        };

        document.getElementById('btn-search').onclick = async () => {
            const tid = document.getElementById('friend-search').value.trim().toLowerCase();
            const snap = await get(ref(db, `users/${tid}`));
            if (snap.exists() && tid !== myId) {
                await set(ref(db, `users/${tid}/requests/${myId}`), { from: myId });
                alert("Request Sended!");
            } else alert("User not found");
        };

        window.challengeFriend = (fid) => {
            const mId = `m_${Date.now()}`;
            set(ref(db, `users/${fid}/invites/${myId}`), { mId, sz: boardSize, from: myId });
            alert("Invite Sended!");
        };

        async function startFriendMatch(sid, data) {
            const mId = data.mId;
            const match = { id: mId, sz: data.sz, players: [sid, myId], board: new Array(data.sz*data.sz).fill(-1), turn: 0, status: 'playing' };
            await set(ref(db, `matches/${mId}`), match);
            await update(ref(db, `users/${sid}`), { match: mId });
            await update(ref(db, `users/${myId}`), { match: mId });
            remove(ref(db, `users/${myId}/invites/${sid}`));
        }

        // --- MATCHMAKING ---
        document.getElementById('btn-matchmaking').onclick = async () => {
            document.getElementById('mm-status').classList.remove('hidden');
            const snap = await get(ref(db, `queue/${boardSize}`));
            if (snap.exists()) {
                const oppId = Object.keys(snap.val())[0];
                if (oppId !== myId) {
                    const mId = `m_${Date.now()}`;
                    await set(ref(db, `matches/${mId}`), { id: mId, sz: boardSize, players: [oppId, myId], board: new Array(boardSize*boardSize).fill(-1), turn: 0, status: 'playing' });
                    await update(ref(db, `users/${oppId}`), { match: mId });
                    await update(ref(db, `users/${myId}`), { match: mId });
                    remove(ref(db, `queue/${boardSize}/${oppId}`));
                    return;
                }
            }
            set(ref(db, `queue/${boardSize}/${myId}`), true);
            onDisconnect(ref(db, `queue/${boardSize}/${myId}`)).remove();
        };

        // --- GAME ENGINE ---
        function startMatch(mId) {
            activeMatchId = mId;
            onValue(ref(db, `matches/${mId}`), (s) => {
                const d = s.val(); if (!d) return;
                matchData = d; myIdx = d.players.indexOf(myId); boardSize = d.sz;
                if (d.status === 'playing') {
                    show('game'); setupBoard(); updateHUD(); draw(); startTimer(); listenChat();
                } else showEnd(d.winner);
            });
        }

        function setupBoard() {
            const h = window.innerHeight * 0.7, w = window.innerWidth - 40;
            hexRad = Math.min(w / (boardSize * 2.5), h / (boardSize * 1.5), 25);
            canvas.width = (boardSize * 1.732 * hexRad) + (boardSize * hexRad);
            canvas.height = (boardSize * 1.5 * hexRad) + hexRad;
        }

        function draw() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            for(let r=0; r<boardSize; r++) {
                for(let c=0; c<boardSize; c++) {
                    const x = (c*hexRad*1.732) + hexRad + (r*hexRad*0.866), y = (r*hexRad*1.5) + hexRad;
                    const o = matchData.board[r*boardSize+c];
                    ctx.beginPath();
                    for(let i=0; i<6; i++) ctx.lineTo(x+hexRad*Math.cos(Math.PI/3*i+Math.PI/6), y+hexRad*Math.sin(Math.PI/3*i+Math.PI/6));
                    ctx.closePath();
                    ctx.fillStyle = o === 0 ? '#38bdf8' : o === 1 ? '#f472b6' : '#1e293b';
                    ctx.fill(); ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.stroke();
                }
            }
        }

        canvas.onclick = (e) => {
            if (matchData.turn !== myIdx) return;
            const rct = canvas.getBoundingClientRect();
            const mx = e.clientX-rct.left, my = e.clientY-rct.top;
            for(let r=0; r<boardSize; r++) {
                for(let c=0; c<boardSize; c++) {
                    const x = (c*hexRad*1.732) + hexRad + (r*hexRad*0.866), y = (r*hexRad*1.5) + hexRad;
                    if(Math.hypot(mx-x, my-y) < hexRad * 0.8) {
                        const idx = r*boardSize+c;
                        if(matchData.board[idx] === -1) {
                            const nb = [...matchData.board]; nb[idx] = myIdx;
                            const won = checkWin(myIdx, nb, boardSize);
                            update(ref(db, `matches/${activeMatchId}`), { board: nb, turn: 1-myIdx, status: won?'finished':'playing', winner: won?myId:null });
                        }
                    }
                }
            }
        };

        function checkWin(p, b, s) {
            const vis = new Set(), q = [];
            if(p===0) { for(let i=0; i<s; i++) if(b[i]===0) q.push([0,i]); }
            else { for(let i=0; i<s; i++) if(b[i*s]===1) q.push([i,0]); }
            while(q.length > 0) {
                const [r,c] = q.shift(); const k = `${r},${c}`;
                if(vis.has(k)) continue; vis.add(k);
                if(p===0 && r===s-1) return true;
                if(p===1 && c===s-1) return true;
                [[r-1,c],[r-1,c+1],[r,c-1],[r,c+1],[r+1,c-1],[r+1,c]].forEach(([nr,nc]) => {
                    if(nr>=0 && nr<s && nc>=0 && nc<s && b[nr*s+nc]===p) q.push([nr,nc]);
                });
            } return false;
        }

        // --- CHAT LOGIC ---
        function listenChat() {
            onValue(ref(db, `matches/${activeMatchId}/chat`), (s) => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = '';
                const data = s.val() || {};
                Object.values(data).forEach(m => {
                    const d = document.createElement('div');
                    d.className = `msg ${m.user === myId ? 'me' : 'them'}`;
                    d.innerText = m.text;
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        document.getElementById('btn-chat-send').onclick = () => {
            const text = document.getElementById('chat-input').value.trim();
            if(text) {
                push(ref(db, `matches/${activeMatchId}/chat`), { user: myId, text });
                document.getElementById('chat-input').value = '';
            }
        };

        function updateHUD() {
            document.getElementById('p1-name').innerText = matchData.players[0];
            document.getElementById('p2-name').innerText = matchData.players[1];
            document.getElementById('p1-hud').classList.toggle('active', matchData.turn === 0);
            document.getElementById('p2-hud').classList.toggle('active', matchData.turn === 1);
        }

        function startTimer() {
            clearInterval(timerInt); let l = 15;
            timerInt = setInterval(() => {
                l--; document.getElementById('timer-val').innerText = l;
                if(l<=0) { clearInterval(timerInt); if(matchData.turn===myIdx) forfeit(); }
            }, 1000);
        }

        const forfeit = () => {
            const opp = matchData.players.find(id => id !== myId);
            update(ref(db, `matches/${activeMatchId}`), { status: 'finished', winner: opp });
        };

        async function showEnd(wid) {
            const isMe = wid === myId;
            document.getElementById('result-text').innerText = isMe ? "VICTORY" : "DEFEAT";
            if(isMe) {
                const snap = await get(ref(db, `users/${myId}/coins`));
                const current = snap.val() || 0;
                await update(ref(db, `users/${myId}`), { coins: current + 50 });
                document.getElementById('coin-reward').classList.remove('hidden');
            } else {
                document.getElementById('coin-reward').classList.add('hidden');
            }
            show('result');
        }

        document.getElementById('btn-back').onclick = () => {
            remove(ref(db, `users/${myId}/match`));
            location.reload();
        };

        document.getElementById('mute-btn').onclick = () => {
            const m = audio.toggle();
            document.getElementById('mute-btn').innerText = m ? 'ðŸ”‡' : 'ðŸ”Š';
        };

        document.getElementById('friend-toggle-btn').onclick = () => {
            document.getElementById('sidebar-panel').classList.toggle('active');
        };

        document.querySelectorAll('.sz-btn').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('.sz-btn').forEach(btn => btn.classList.remove('active').style.border='none');
                b.classList.add('active'); b.style.border='1px solid var(--primary)';
                boardSize = parseInt(b.dataset.sz);
            };
        });

    </script>
</body>
</html>